package com.cet.cet;

import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.context.annotation.Bean;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.StringUtils;

import java.util.List; 
import java.util.ArrayList; 
import java.util.HashMap; 
import java.util.HashSet;
import java.util.Map; 

import java.net.Authenticator;
import java.net.PasswordAuthentication;

import org.json.JSONObject;
import org.json.JSONArray;
import org.javatuples.Pair;

import com.cet.managementservice.*;

@RestController
public class CetController {
    @Autowired ManagementServiceClient client;

    @GetMapping("/attributes")
    @ResponseStatus(HttpStatus.OK)
    public String index() {
        ModuleKey module = new ModuleKey();
        module.setName("Kinderbijslag");
        module.setModuleType(ModuleType.fromValue("Interaction"));

        List<ModuleElementKey> entityKeys = client.getModuleElements("Kinderbijslag", "Trunk", "Kinderbijslag", module, ModuleElementType.fromValue("Entity"));
        List<Entity> entities = new ArrayList<Entity>();
        HashMap<String, List<String>> derived = new HashMap<String, List<String>>();

        for (ModuleElementKey entityKey: entityKeys) {
            Entity entity = (Entity) client.getModuleElement("Kinderbijslag", "Trunk", "Kinderbijslag", module, entityKey);
            entities.add(entity);
            derived.put(entity.getName(), new ArrayList<String>());
        }

        for (Entity entity: entities) {
            if (entity.getBaseEntity() != null) {
                derived.get(entity.getBaseEntity()).add(entity.getName());
            }
        }

        JSONObject json = new JSONObject();

        List<ModuleElementKey> attributeKeys = client.getModuleElements("Kinderbijslag", "Trunk", "Kinderbijslag", module, ModuleElementType.fromValue("Attribute"));
        for (ModuleElementKey attributeKey: attributeKeys) {
            Attribute attribute = (Attribute) client.getModuleElement("Kinderbijslag", "Trunk", "Kinderbijslag", module, attributeKey);
            JSONObject info = new JSONObject();
            info.put("questionText", getQuestionText(attribute));

            HashSet<String> tmp = new HashSet<String>();
            dfs(attribute.getEntity(), derived, tmp);
            JSONArray attrEntities = new JSONArray();

            for (String entity: tmp) {
                attrEntities.put(entity);
            }

            info.put("entities", attrEntities);
            json.put(attribute.getEntity() + "." + attribute.getName(), info); 
        }
        return json.toString();
    }

    private JSONObject getQuestionText(Attribute attribute) {
        JSONObject result = new JSONObject();
        result.put("nl", "");
        result.put("en", "");
        for (MultiLingualText mlt: attribute.getQuestionText().getText()) {
            if (mlt.getLanguage().equals("Nederlands")) {
                result.put("nl", mlt.getValue());
            } else if (mlt.getLanguage().equals("English")) {
                result.put("en", mlt.getValue());
            } 
        }
        return result;
    }

    private void dfs(String u, Map<String, List<String>> g, HashSet<String> s) {
        s.add(u);
        for (String v: g.get(u)) {
            dfs(v, g, s);
        }
    }

    //@GetMapping("/test")
    //@ResponseStatus(HttpStatus.OK)
    //public void getPageContent() {
        //ModuleKey moduleKey = new ModuleKey();
        //moduleKey.setName("Kinderbijslag");
        //moduleKey.setModuleType(ModuleType.fromValue("Interaction"));

        //ModuleElementKey elementKey = new ModuleElementKey();
        //elementKey.setName("OuderGegevens");
        //elementKey.setModuleElementType(ModuleElementType.fromValue("Page"));
        //Page page = (Page)client.getModuleElement("Kinderbijslag", "Trunk", "Kinderbijslag", moduleKey, elementKey);

        //System.out.println("OK");
        //for (Containment containment: page.getContainments().getContainment()) {
            //retreive(containment);
        //}
        //System.out.println("DONE");
    //}

    //private void retreive(Containment containment) {
        
        //if (containment instanceof AttributeReference) {
            //AttributeReference ref = (AttributeReference) containment;
            //System.out.println(ref.getEntity() + "." + ref.getAttribute());
            //return;
        //}
        
        //if (containment instanceof ContainerContainment) {
            //Container container = ((ContainerContainment)containment).getContainer();

            //ParameterContent pc = container.getParameterContent();
            //if (pc instanceof DefaultContent) {
                //DefaultContent content = (DefaultContent) pc;
                //for (Containment c: content.getContainments().getContainment()) {
                    //retreive(c);
                //}
            //}
        //} else if (containment instanceof ContainerReference) {
            //ContainerReference cr = (ContainerReference)containment;
            //ModuleKey moduleKey = new ModuleKey();
            //moduleKey.setName("Kinderbijslag");
            //moduleKey.setModuleType(ModuleType.fromValue("Interaction"));

            //ModuleElementKey elementKey = new ModuleElementKey();
            //elementKey.setName(cr.getContainer());
            //elementKey.setModuleElementType(ModuleElementType.fromValue("Container"));
            //Container container = (Container)client.getModuleElement("Kinderbijslag", "Trunk", "Kinderbijslag", moduleKey, elementKey); 

            //ParameterContent pc = container.getParameterContent();
            //if (pc instanceof DefaultContent) {
                //DefaultContent content = (DefaultContent) pc;
                //for (Containment c: content.getContainments().getContainment()) {
                    //retreive(c);
                //}
            //}
        //} 

    //}

    //@GetMapping("/attributes")
    //@ResponseStatus(HttpStatus.OK)
    //public String getAttributes() {
        //JSONObject data = new JSONObject();
        //for (Pair<AttributeKey, Attribute> p: attributes) {
            //Attribute attribute = p.getValue1();
            //JSONObject properties = new JSONObject();
            //JSONObject questionText = new JSONObject();
            //for (MultiLingualText mlt: attribute.getQuestionText().getText()) {
                //questionText.put(mlt.getLanguage(), mlt.getValue());
            //}
            //properties.put("questionText", questionText);
            //data.put(attribute.getName(), properties);
        //}
        //return data.toString();
    //}

    @PostMapping("/requestChanges")
    @ResponseStatus(HttpStatus.OK)
    public void requestChanges(@RequestBody String raw) {
        ModuleKey module = new ModuleKey();
        module.setName("Kinderbijslag");
        module.setModuleType(ModuleType.fromValue("Interaction"));

        JSONObject json = new JSONObject(raw);
        ArrayList<Attribute> attributes = new ArrayList<Attribute>();
        for (String s: json.keySet()) {
            String[] tmp = s.split(".", 2);
            String entity = tmp[0];
            String name = tmp[1];

            AttributeKey key = new AttributeKey();
            key.setName(name);
            key.setEntity(entity);

            Attribute attribute = (Attribute) client.getModuleElement("Kinderbijslag", "Trunk", "Kinderbijslag", module, key);
            attribute.setName(name);
            attribute.setEntity(entity);

            setQuestionText(attribute, json.getJSONObject(s).getJSONObject("questionText"));
            
            attributes.add(attribute);
        }
        requestChanges(attributes);
    }

    private void setQuestionText(Attribute attribute, JSONObject json) {
        for (MultiLingualText mlt: attribute.getQuestionText().getText()) {
            if (mlt.getLanguage().equals("Nederlands")) {
                mlt.setValue(json.getString("nl")); 
            } else if (mlt.getLanguage().equals("English")) {
                mlt.setValue(json.getString("en")); 
            } 
        }
    }

    //private List<Pair<AttributeKey, Attribute>> getModified(JSONObject data) {
        //ArrayList<Pair<AttributeKey, Attribute>> result = new ArrayList<Pair<AttributeKey, Attribute>>();

        //for (Pair<AttributeKey, Attribute> p: attributes) {
            //Attribute attribute = p.getValue1();
            //boolean modified = false;
            //for (MultiLingualText mlt: attribute.getQuestionText().getText()) {
                //String originalText = mlt.getValue();
                //String requestText = data.getJSONObject(attribute.getName()).getJSONObject("questionText").getString(mlt.getLanguage());
                //if (!originalText.equals(requestText)) {
                    //modified = true;
                    //mlt.setValue(requestText);
                //}
            //}
            //if (modified) { 
                //result.add(new Pair<AttributeKey, Attribute>(p.getValue0(), attribute));
            //}
        //}
        //return result;
    //}

    //private void initialize() {
        //initModule();
        //initAttributes();
    //}
    
    //private void initModule() {
        //List<ModuleKey> modules = client.getModules(repository, branch, project);
        //for (ModuleKey m: modules) {
            //if (m.getModuleType().value() == "Interaction") {
                //module = m;
                //return;
            //}
        //}
    //}

    //private void initAttributes() {
        //attributes = new ArrayList<Pair<AttributeKey, Attribute>>();
        //List<ModuleElementKey> keys = client.getAllModuleElements(repository, branch, project, module);
        //for (ModuleElementKey key: keys) {
            //ModuleElement element = client.getModuleElement(repository, branch, project, module, key);
            //if (element instanceof Attribute) {
                //attributes.add(new Pair<AttributeKey, Attribute>((AttributeKey)key, (Attribute)element));
           //}
       //}
    //}

    //private void createRequestChangesBranch() {
        //Branch cetBranch = new Branch();
        //cetBranch.setName("CET_request");
        //client.createFeatureBranch(repository, branch, cetBranch);
    //}

    private void requestChanges(List<Attribute> attributes) {
        //createRequestChangesBranch();
        ModuleKey module = new ModuleKey();
        module.setName("Kinderbijslag");
        module.setModuleType(ModuleType.fromValue("Interaction"));

        ArrayOfOperationEntry arrayOfOperationEntry = new ArrayOfOperationEntry();
        List<OperationEntry> operations = arrayOfOperationEntry.getOperationEntry(); 

        for (Attribute attribute: attributes) {
            AttributeKey key = new AttributeKey();
            key.setName(attribute.getName());
            key.setEntity(attribute.getEntity());

            ModuleElementOperation operation = new ModuleElementOperation();

            operation.setProject("Kinderbijslag");
            operation.setModule(module);
            operation.setOriginalKey(key);
            operation.setModuleElement(attribute);
            operation.setType(ChangeType.fromValue("Update"));

            OperationEntry operationEntry = new OperationEntry();
            operationEntry.setModuleElementOperation(operation);
            operations.add(operationEntry);
        }

        OperationSet operationSet = new OperationSet();
        operationSet.setOperations(arrayOfOperationEntry);

        client.applyOperations(repository, "CET_request", operationSet);
    }
}
